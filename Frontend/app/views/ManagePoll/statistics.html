#{extends 'main.html' /} #{ set title:'Statistics for poll #' + pollID /} 
#{set moreStyles:'managepoll' /}
#{set moreScripts:'highcharts-2.2.0' /}
<script type="text/javascript" src="/public/javascripts/exporting.js"></script>
<div id="main">
	<div class="greybg">
		<div class="wrapper">
			<div id="stats"></div>
			<img class="loading" src="@{'/public/images/loading-big.gif'}" alt="&{'loading'}"/>
			<div id="responsed" style="text-align:center; margin-top:15px;" />
		</div>
	</div>
</div>

<script type="text/javascript">
$(document).ready(function() {
	Highcharts.theme = {
		colors: ["#A4C765"],
		chart: {
			backgroundColor: {
				linearGradient: [0, 0, 0, 400],
				stops: [[0, 'rgb(67, 67, 67)']]
	     	},
			borderWidth: 0,
			borderRadius: 15,
			plotBackgroundColor: null,
			plotShadow: false,
			plotBorderWidth: 0
		},
		title: {
			style: { 
				color: '#FFF',
			    font: '16px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
			}
		},
		xAxis: {
			gridLineWidth: 0,
			lineColor: '#666',
			tickColor: '#666',
			labels: {
				style: {
					color: '#fff',
			        fontWeight: 'bold'
			    }
			},
			title: {
				style: {
					color: '#fff',
					font: '12px "Lucida Grande",Tahoma,"Bitstream Vera Sans",Arial,sans-serif'
				}            
			}
		},
		yAxis: {
			alternateGridColor: null,
			minorTickInterval: null,
			gridLineColor: 'rgba(255, 255, 255, .1)',
			lineWidth: 0,
			tickWidth: 0,
			labels: {
				style: {
					color: '#fff',
					fontWeight: 'bold'
				}
			},
			title: {
				style: {
					color: '#fff',
					font: '12px "Lucida Grande",Tahoma,"Bitstream Vera Sans",Arial,sans-serif'
				}            
			}
		},
		tooltip: {
			backgroundColor: {
				linearGradient: [0, 0, 0, 50],
				stops: [[0, 'rgba(96, 96, 96, .8)']]
			},
			borderWidth: 0,
			style: {
				color: '#FFF'
			}
		},
	};
				
	var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

	//$.getJSON('@{ManagePoll.testStatistics()}', function(data) {
	$.getJSON('/api/pollinstance/${pollinstance_id}', function(data) {
		console.log("Returns: ", data);
		$('.loading').hide();
			len = data.votes.length;
						sum = 0;
						var myVotes = new Array();
						for (i=0; i<len; i++) {
							sum += data.votes[i];
						}
						for (i=0; i<len; i++) {
							myVotes[i] = data.votes[i]*100/sum;
						}
						$("#responsed").html("&{'num_of_resp'} <b style=\"color:#a4c765;\">"+sum+"</b>");
		var chart = new Highcharts.Chart({
		      chart: {
		         renderTo: 'stats',
		         defaultSeriesType: 'column',
		         marginRight: 10,
		         events: {
		             load: function() {
		                // set up the updating of the chart each second
		                var series = this.series[0];
						len = data.votes.length;
						sum = 0;
						var myVotes = new Array();
						for (i=0; i<len; i++) {
							sum += data.votes[i];
						}
						for (i=0; i<len; i++) {
							myVotes[i] = data.votes[i]*100/sum;
						}
		                setInterval(function() {
		                    //$.getJSON('@{ManagePoll.testStatistics()}', function(data) {
		                    $.getJSON('/api/pollinstance/${pollinstance_id}', function(data) {
		                        series.setData(data.votes);
		                    });
		            	}, 5000);
		        	}
				}
		    },
		    title: {
		    	text: data.question
		    },
		  	xAxis: {
				categories: data.answers,
				labels: {
			        <!--rotation: -45,-->
			    	align: 'center',
		    	}
			},
			yAxis: {
				min: 0,
				max: 100,
				title: {
					text: '&{'joinpoll.success.yAxis'} (%)'
				}
			},
			tooltip: {
				formatter: function() {
					return Math.round(this.y/100*sum) +' &{'joinpoll.success.votes'}';
				}
			},
		    legend: {
		    	enabled: false
		    },
		    series: [{
				data: myVotes
			}]
		});
	});
});
</script>